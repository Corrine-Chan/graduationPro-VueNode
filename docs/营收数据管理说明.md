# 营收数据管理说明

## 📋 问题说明

营收统计模块的数据是按日期存储的，每天需要有对应日期的数据才能正常显示。

### 原有问题

- 后端查询条件是 `WHERE stat_date = CURDATE()`（只查当天）
- 如果数据库中没有当天的数据，页面就会显示空

### 已修复

✅ 后端已修改为**查询最新日期的数据**，即使数据不是今天的，也会显示最近的营收数据。

## 🔧 数据管理方案

### 方案1：自动生成每日数据（推荐用于演示）

使用脚本自动生成指定日期的营收数据：

```bash
# 进入后端目录
cd backend

# 生成今天的数据
node scripts/generateDailyRevenue.js

# 生成指定日期的数据
node scripts/generateDailyRevenue.js 2026-02-04
```

**脚本功能**：

- 自动读取所有充电站信息
- 为每个充电站生成随机的营收数据（模拟真实业务）
- 插入到 `station_revenue` 表中
- 检查是否已存在数据，避免重复插入

### 方案2：更新现有数据日期

如果只是想让现有数据显示为今天的日期：

```bash
cd backend
node scripts/updateRevenueDate.js
```

**注意**：这会将所有营收数据的日期更新为今天。

### 方案3：手动在数据库中插入

直接在 MySQL 中执行 INSERT 语句，参考 `database/schema.sql` 中的示例数据。

## 📊 数据表结构

### station_revenue（充电站营收统计表）

| 字段名              | 类型          | 说明             |
| ------------------- | ------------- | ---------------- |
| station_id          | VARCHAR(50)   | 站点ID           |
| station_name        | VARCHAR(200)  | 站点名称         |
| city                | VARCHAR(50)   | 所属城市         |
| pile_count          | INT           | 充电桩总数量     |
| electricity_fee     | DECIMAL(10,2) | 电费营收(元)     |
| parking_fee         | DECIMAL(10,2) | 停车费营收(元)   |
| service_fee         | DECIMAL(10,2) | 服务费营收(元)   |
| member_recharge     | DECIMAL(10,2) | 会员储值金(元)   |
| daily_total         | DECIMAL(10,2) | 单日总收入(元)   |
| monthly_total       | DECIMAL(10,2) | 月度总收入(万元) |
| daily_growth_rate   | DECIMAL(5,2)  | 日增长率(%)      |
| monthly_growth_rate | DECIMAL(5,2)  | 月增长率(%)      |
| stat_date           | DATE          | 统计日期         |

## 🎯 实际生产环境建议

在真实的生产环境中，营收数据应该：

1. **自动统计**：通过定时任务（如 cron job）每天凌晨自动统计前一天的营收
2. **从订单表计算**：基于 `charging_orders` 表的实际订单数据进行汇总
3. **实时更新**：每笔订单完成后实时更新当天的营收统计

### 示例：定时任务实现

```javascript
// 每天凌晨1点执行
// cron: '0 1 * * *'

async function generateDailyRevenue() {
  const yesterday = new Date();
  yesterday.setDate(yesterday.getDate() - 1);

  // 从订单表统计昨天的营收
  const revenue = await pool.query(
    `
    SELECT 
      s.station_id,
      s.station_name,
      s.city,
      COUNT(o.id) as order_count,
      SUM(o.amount) as total_revenue
    FROM charging_orders o
    JOIN charging_stations s ON o.station_id = s.id
    WHERE DATE(o.created_at) = ?
    GROUP BY s.station_id
  `,
    [yesterday],
  );

  // 插入到营收统计表
  // ...
}
```

## 📝 常见问题

### Q1: 为什么页面显示"无数据"？

**A**: 数据库中没有当天或最新日期的营收数据。运行 `generateDailyRevenue.js` 生成数据即可。

### Q2: 每天都要手动生成数据吗？

**A**:

- **演示环境**：是的，需要手动运行脚本
- **生产环境**：应该配置定时任务自动生成

### Q3: 数据是真实的吗？

**A**: 当前是模拟数据。真实环境应该从订单表统计实际营收。

### Q4: 可以查看历史数据吗？

**A**: 当前版本只显示最新日期的数据。如需查看历史数据，需要在前端添加日期选择器。

## 🚀 快速开始

如果你是第一次使用或者发现页面无数据：

```bash
# 1. 进入后端目录
cd backend

# 2. 生成今天的营收数据
node scripts/generateDailyRevenue.js

# 3. 启动后端服务（如果还没启动）
npm run dev

# 4. 刷新前端页面
```

---

**最后更新**: 2026-02-03
