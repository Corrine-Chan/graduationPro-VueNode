# 电子地图模块问题排查指南

## 问题现象

地图页面显示错误：

- `Request failed with status code 404`
- 统计数据显示"暂无数据"
- 地图上没有站点标记

## 排查步骤

### 步骤1：检查后端服务是否启动

打开新的命令行窗口，执行：

```bash
cd backend
npm run dev
```

**预期输出**：

```
🚀 服务器运行在 http://localhost:5501
✅ 数据库连接成功
```

**如果看到错误**：

- 数据库连接失败 → 检查MySQL是否运行，检查 `backend/.env` 配置
- 端口被占用 → 修改 `backend/.env` 中的 PORT

### 步骤2：检查数据库中是否有数据

执行检查脚本：

```bash
cd backend
node scripts/checkMapData.js
```

**预期输出**：

```
============================================================
🔍 检查地图站点数据
============================================================

1. 检查 map_stations 表是否存在...
✅ map_stations 表存在

2. 检查数据数量...
✅ 共有 32 条数据

3. 检查启用的站点...
✅ 启用的站点: 32 个

4. 显示前5条数据...
  1. 北京西单充电站 (VXZ10001)
     地址: 北京市西城区西单北大街
     坐标: [116.395645, 39.90923]
     状态: 1, 充电桩数: 135, 启用: 是
...
```

**如果表不存在或没有数据**，执行以下命令：

#### Windows (使用 MySQL 命令行)：

```bash
# 方法1：使用 mysql 命令
mysql -u root -p charging_station < database/schema.sql

# 方法2：登录 MySQL 后执行
mysql -u root -p
USE charging_station;
SOURCE D:/path/to/your/project/database/schema.sql;
```

#### 或者手动执行 SQL：

1. 打开 MySQL Workbench 或其他数据库工具
2. 连接到 `charging_station` 数据库
3. 打开 `database/schema.sql` 文件
4. 找到以下部分并执行：

```sql
-- 创建地图站点表
CREATE TABLE IF NOT EXISTS map_stations (
  id INT PRIMARY KEY AUTO_INCREMENT,
  station_id VARCHAR(50) UNIQUE NOT NULL COMMENT '站点ID',
  station_name VARCHAR(200) NOT NULL COMMENT '站点名称',
  address VARCHAR(255) NOT NULL COMMENT '站点地址',
  longitude DECIMAL(11, 8) NOT NULL COMMENT '经度',
  latitude DECIMAL(10, 8) NOT NULL COMMENT '纬度',
  status TINYINT NOT NULL DEFAULT 1 COMMENT '状态: 1-空闲 2-使用中 3-维护中 4-故障 5-待维修',
  pile_count INT NOT NULL DEFAULT 0 COMMENT '充电桩数量',
  is_active TINYINT NOT NULL DEFAULT 1 COMMENT '是否启用: 0-未启用 1-已启用',
  remarks TEXT COMMENT '备注信息',
  operator VARCHAR(50) COMMENT '操作员',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  INDEX idx_station_id (station_id),
  INDEX idx_status (status),
  INDEX idx_is_active (is_active)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='地图站点表';

-- 插入示例地图站点数据
INSERT INTO map_stations (station_id, station_name, address, longitude, latitude, status, pile_count, is_active) VALUES
('VXZ10001', '北京西单充电站', '北京市西城区西单北大街', 116.395645, 39.90923, 1, 135, 1),
('VXZ10002', '上海陆家嘴充电站', '上海市浦东新区陆家嘴环路', 121.491121, 31.236222, 2, 125, 1),
('VXZ10003', '广州花城广场充电站', '广州市天河区花城广场', 113.32452, 23.097418, 2, 123, 1),
('VXZ10004', '深圳大梅沙充电站', '深圳市盐田区大梅沙', 114.156836, 22.283758, 1, 110, 1),
('VXZ10005', '成都天府广场充电站', '成都市锦江区天府广场', 104.065735, 30.659462, 5, 125, 1),
('VXZ10006', '西安钟楼充电站', '西安市碑林区钟楼', 108.948024, 34.263161, 4, 115, 1),
('VXZ10007', '杭州西湖充电站', '杭州市西湖区西湖景区', 120.15507, 30.274084, 1, 104, 1),
('VXZ10008', '南京夫子庙充电站', '南京市秦淮区夫子庙', 118.796877, 32.060255, 2, 129, 1),
('VXZ10009', '天津意大利风情区充电站', '天津市河北区意大利风情区', 117.200983, 39.084158, 2, 123, 1),
('VXZ10010', '青岛栈桥充电站', '青岛市市南区栈桥', 120.308949, 36.065319, 1, 123, 1),
('VXZ10011', '武汉黄鹤楼充电站', '武汉市武昌区黄鹤楼', 114.305393, 30.593099, 2, 102, 1),
('VXZ10012', '福州三坊七巷充电站', '福州市鼓楼区三坊七巷', 119.296494, 26.074507, 4, 107, 1),
('VXZ10013', '合肥包公园充电站', '合肥市包河区包公园', 117.283042, 31.86119, 2, 100, 1),
('VXZ10014', '重庆解放碑充电站', '重庆市渝中区解放碑', 106.551556, 29.563009, 2, 117, 1),
('VXZ10015', '桂林漓江充电站', '桂林市象山区漓江', 110.290195, 25.273566, 2, 106, 1),
('VXZ10016', '苏州园区充电站', '苏州市工业园区', 120.619585, 31.299379, 2, 115, 1),
('VXZ10017', '昆明滇池充电站', '昆明市西山区滇池', 102.833218, 24.879659, 1, 112, 1),
('VXZ10018', '南宁青秀山充电站', '南宁市青秀区青秀山', 108.327546, 22.815478, 2, 117, 1),
('VXZ10019', '长沙橘子洲头充电站', '长沙市岳麓区橘子洲', 112.938814, 28.228209, 2, 112, 1),
('VXZ10020', '哈尔滨中央大街充电站', '哈尔滨市道里区中央大街', 126.534967, 45.802664, 2, 107, 1),
('VXZ10021', '石家庄正定古城充电站', '石家庄市正定县古城', 114.514859, 38.042306, 4, 103, 1),
('VXZ10022', '兰州黄河桥充电站', '兰州市城关区黄河桥', 103.834302, 36.061089, 5, 126, 1),
('VXZ10023', '济南大明湖充电站', '济南市历下区大明湖', 116.994929, 36.682785, 1, 132, 1),
('VXZ10024', '沈阳故宫充电站', '沈阳市沈河区故宫', 123.431474, 41.805699, 4, 108, 1),
('VXZ10025', '福州西湖充电站', '福州市鼓楼区西湖公园', 119.302444, 26.080429, 2, 113, 1),
('VXZ10026', '无锡灵山大佛充电站', '无锡市滨湖区灵山', 120.31191, 31.498809, 1, 123, 1),
('VXZ10027', '郑州二七广场充电站', '郑州市二七区二七广场', 113.558519, 34.857641, 1, 120, 1),
('VXZ10028', '大连星海广场充电站', '大连市沙河口区星海广场', 121.614682, 38.914003, 2, 117, 1),
('VXZ10029', '宁波天一广场充电站', '宁波市海曙区天一广场', 121.551918, 29.874058, 4, 130, 1),
('VXZ10030', '贵阳甲秀楼充电站', '贵阳市南明区甲秀楼', 106.713478, 26.578343, 1, 114, 1),
('VXZ10031', '珠海长隆海洋王国充电站', '珠海市横琴新区长隆', 113.58239, 22.276949, 1, 114, 1),
('VXZ10032', '天津滨海新区充电站', '天津市滨海新区', 117.701648, 39.041746, 1, 129, 1)
ON DUPLICATE KEY UPDATE
  station_name = VALUES(station_name),
  pile_count = VALUES(pile_count),
  status = VALUES(status);
```

### 步骤3：验证数据是否插入成功

在 MySQL 中执行：

```sql
SELECT COUNT(*) FROM map_stations;
-- 应该返回 32

SELECT * FROM map_stations LIMIT 5;
-- 应该显示前5条数据
```

### 步骤4：测试后端API

确保后端正在运行（步骤1），然后执行：

```bash
cd backend
node scripts/testMapApi.js
```

这将测试所有地图相关的API接口。

### 步骤5：检查前端配置

确认 `frontend/.env.development` 文件内容：

```env
VITE_API_URL=http://localhost:5501
```

**重要**：修改环境变量后，必须重启前端服务！

```bash
# 停止前端服务（Ctrl+C）
# 然后重新启动
cd frontend
npm run dev
```

### 步骤6：清除浏览器缓存

1. 打开浏览器开发者工具（F12）
2. 右键点击刷新按钮
3. 选择"清空缓存并硬性重新加载"

或者使用无痕模式访问：`Ctrl + Shift + N`

## 完整启动流程

### 1. 启动后端

```bash
cd backend
npm run dev
```

等待看到：

```
🚀 服务器运行在 http://localhost:5501
```

### 2. 启动前端

```bash
cd frontend
npm run dev
```

等待看到：

```
VITE ready in xxx ms
Local: http://localhost:5173/
```

### 3. 访问系统

打开浏览器访问：http://localhost:5173

登录账号：`admin123456` / `123456`

点击左侧菜单"电子地图"

## 常见错误及解决方案

### 错误1：404 Not Found

**原因**：后端服务未启动或端口不匹配

**解决**：

1. 确认后端正在运行
2. 检查 `backend/.env` 中的 PORT
3. 检查 `frontend/.env.development` 中的 VITE_API_URL
4. 重启前端服务

### 错误2：数据库连接失败

**原因**：MySQL未运行或配置错误

**解决**：

1. 启动MySQL服务
2. 检查 `backend/.env` 中的数据库配置
3. 确认数据库 `charging_station` 存在

### 错误3：表不存在

**原因**：数据库表未创建

**解决**：
执行 `database/schema.sql` 中的建表语句

### 错误4：没有数据

**原因**：数据未插入

**解决**：
执行 `database/schema.sql` 中的 INSERT 语句

### 错误5：地图不显示

**原因**：高德地图API key问题

**解决**：
检查 `frontend/src/components/map/MapContainer.vue` 中的 key 是否有效

## 验证清单

- [ ] MySQL 服务正在运行
- [ ] 数据库 `charging_station` 存在
- [ ] 表 `map_stations` 存在
- [ ] 表中有32条数据
- [ ] 后端服务正在运行（端口5501）
- [ ] 前端服务正在运行（端口5173）
- [ ] 环境变量配置正确
- [ ] 浏览器缓存已清除
- [ ] 能够成功登录系统
- [ ] 地图页面正常显示
- [ ] 地图上有站点标记
- [ ] 统计数据正常显示

## 快速修复命令

如果一切都配置正确但仍然有问题，尝试以下命令：

```bash
# 1. 重新导入数据库
mysql -u root -p charging_station < database/schema.sql

# 2. 检查数据
cd backend
node scripts/checkMapData.js

# 3. 重启后端
cd backend
npm run dev

# 4. 重启前端（新窗口）
cd frontend
npm run dev

# 5. 清除浏览器缓存并刷新页面
```

## 联系支持

如果以上步骤都无法解决问题，请提供以下信息：

1. 后端启动日志
2. 前端控制台错误信息
3. `node scripts/checkMapData.js` 的输出
4. MySQL 版本
5. Node.js 版本

---

**最后更新**: 2026-02-04
