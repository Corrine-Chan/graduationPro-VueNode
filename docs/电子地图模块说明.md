# 电子地图模块功能说明

## 功能概述

电子地图模块已完成前后端联调和数据库绑定，支持以下功能：

### 1. 地图站点展示

- ✅ 从数据库读取所有启用的充电站点
- ✅ 在地图上使用 flashIcon 图标标记站点位置
- ✅ 点击标记显示站点详细信息（名称、充电桩数量、状态、地址）
- ✅ 根据站点状态显示不同颜色（空闲-绿色、使用中-蓝色、维护中-橙色、故障-红色）

### 2. 新增站点功能

- ✅ 表单验证（站点名称、地址、经纬度）
- ✅ 经纬度范围验证（经度：-180~180，纬度：-90~90）
- ✅ 自动生成站点ID（格式：VXZ10001、VXZ10002...）
- ✅ 新增站点后自动刷新地图显示
- ✅ 新增站点数据存储到数据库
- ✅ 新增站点在地图上显示 flashIcon 图标

### 3. 统计数据展示

- ✅ 累计充电站数量
- ✅ 单省份最多充电桩统计
- ✅ 充电站遍及省份数量
- ✅ 暂无充电站省份数量
- ✅ 单日营收最高/最低站点
- ✅ 故障率最高站点

## 数据库表结构

### map_stations 表

```sql
CREATE TABLE IF NOT EXISTS map_stations (
  id INT PRIMARY KEY AUTO_INCREMENT,
  station_id VARCHAR(50) UNIQUE NOT NULL COMMENT '站点ID',
  station_name VARCHAR(200) NOT NULL COMMENT '站点名称',
  address VARCHAR(255) NOT NULL COMMENT '站点地址',
  longitude DECIMAL(11, 8) NOT NULL COMMENT '经度',
  latitude DECIMAL(10, 8) NOT NULL COMMENT '纬度',
  status TINYINT NOT NULL DEFAULT 1 COMMENT '状态: 1-空闲 2-使用中 3-维护中 4-故障 5-待维修',
  pile_count INT NOT NULL DEFAULT 0 COMMENT '充电桩数量',
  is_active TINYINT NOT NULL DEFAULT 1 COMMENT '是否启用: 0-未启用 1-已启用',
  remarks TEXT COMMENT '备注信息',
  operator VARCHAR(50) COMMENT '操作员',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  INDEX idx_station_id (station_id),
  INDEX idx_status (status),
  INDEX idx_is_active (is_active)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='地图站点表';
```

## API 接口

### 1. 获取地图站点列表

- **接口**: `POST /api/map/mapList`
- **权限**: 需要登录认证
- **返回数据格式**:

```json
{
  "code": 200,
  "success": true,
  "data": [
    {
      "position": [116.395645, 39.90923],
      "title": "北京西单充电站",
      "status": 1,
      "count": 135,
      "address": "北京市西城区西单北大街",
      "id": "VXZ10001",
      "remarks": "备注信息",
      "operator": "操作员",
      "createTime": "2026-02-04 10:00:00"
    }
  ]
}
```

### 2. 创建新站点

- **接口**: `POST /api/map/create`
- **权限**: 需要登录认证
- **请求参数**:

```json
{
  "name": "站点名称",
  "region": "站点地址",
  "longitude": 116.404,
  "latitude": 39.915,
  "isActive": true,
  "remarks": "备注信息",
  "createTime": "2026年02月04日 10:00:00",
  "operator": "操作员"
}
```

- **返回数据**:

```json
{
  "code": 200,
  "success": true,
  "message": "站点创建成功",
  "data": {
    "position": [116.404, 39.915],
    "title": "站点名称",
    "status": 2,
    "count": 0,
    "address": "站点地址",
    "id": "VXZ10033",
    "remarks": "备注信息",
    "operator": "操作员",
    "createTime": "2026年02月04日 10:00:00"
  }
}
```

### 3. 获取地图统计数据

- **接口**: `GET /api/map/stats`
- **权限**: 需要登录认证
- **返回数据**:

```json
{
  "code": 200,
  "success": true,
  "data": {
    "totalStations": 34,
    "maxProvinceStations": "北京(4个)",
    "provinceCount": 14,
    "noStationProvinces": 22,
    "revenueHighest": "北京西单充电站",
    "revenueLowest": "南宁青秀山充电站",
    "faultHighest": "兰州黄河桥充电站"
  }
}
```

## 前端组件

### MapContainer.vue

- 地图容器组件
- 负责地图初始化和标记渲染
- 支持通过 props 接收刷新信号
- 自动更新地图标记

### ElectronicMap.vue

- 电子地图主页面
- 包含地图展示和新增站点表单
- 显示统计数据
- 处理站点创建和数据刷新

## 使用说明

### 1. 查看地图站点

1. 进入"电子地图"菜单
2. 地图自动加载所有启用的站点
3. 点击地图上的 flashIcon 图标查看站点详情

### 2. 新增站点

1. 在右侧"新增站点地图"表单中填写信息
2. 必填项：站点名称、站点地址、经度、纬度
3. 可选项：立即使用（开关）、备注
4. 点击"创建站点"按钮提交
5. 创建成功后地图自动刷新，新站点显示在地图上

### 3. 查看统计数据

- 右侧卡片实时显示各项统计数据
- 数据来源于数据库实时计算
- 新增站点后统计数据自动更新

## 注意事项

1. **经纬度范围**：
   - 经度：-180 到 180
   - 纬度：-90 到 90

2. **站点ID生成规则**：
   - 格式：VXZ + 5位数字（如 VXZ10001）
   - 自动递增，不会重复

3. **站点状态说明**：
   - 1: 空闲中（绿色）
   - 2: 使用中（蓝色）
   - 3: 维护中（橙色）
   - 4: 故障（红色）
   - 5: 待维修（红色）

4. **数据同步**：
   - 新增站点后地图立即刷新
   - 统计数据实时更新
   - 不影响现有功能

## 技术实现

### 后端

- **框架**: Express.js
- **数据库**: MySQL
- **认证**: JWT Token
- **控制器**: mapController.js
- **路由**: map.js

### 前端

- **框架**: Vue 3 + TypeScript
- **地图**: 高德地图 API
- **UI组件**: Element Plus
- **状态管理**: Pinia
- **HTTP请求**: Axios

## 更新日志

### 2026-02-04

- ✅ 创建 map_stations 数据库表
- ✅ 实现后端 API 接口（获取站点列表、创建站点、获取统计数据）
- ✅ 完善前端地图组件，支持动态刷新
- ✅ 新增站点表单验证和提交
- ✅ 实现地图标记点击显示详情
- ✅ 统计数据动态加载
- ✅ 所有功能已测试，不影响现有功能
